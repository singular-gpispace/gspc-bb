///////////////////////////////////////
version="version buchbergergp.lib 0.1 Mar 2025 ";
category="Commutative algebra";
info="
LIBRARY: buchbergergp.lib  procedures for the Buchbergers Test

OVERVIEW:
    This library contains SINGULAR procedures used in the parallel implementation
    of the Buchberger Test in the Singular/GPI-Space framework.
    The newstruct type token  must be defined.

    PROCEDURES:
    init(string)                initialize output token
    abort_BB_test(list, token)  set the output to false if the test fails
";

proc mod_init()
{
    LIB "polylib.lib";
    LIB "general.lib"; // for sort

    system("--ticks-per-sec", 1000);
    newstruct("token", "list fieldnames, list data");
}

// argument order is ALWAYS:
// for inputs:  read  - in  - inout
// for outputs: inout - out - out_many

proc init(string DIR)
{
  token output;
  output.fieldnames[1] = "test_result";
  output.data[1] = 1;

  // This output is just for debugging and analysing the algorithm:
  output.fieldnames[2] = "transition_names";
  output.data[2] = list("total_start_stop", "total_time",   "TRANSITION init TOTAL", "TRANSITION NF_of_spoly TOTAL", "Singular init", "reading ideal for Buchberger test (init)", "building kStrategy object for Buchberger test (init)", "applying criteria in init transition (Buchberger test)", "reading ideal for Buchberger test (static)", "building kStrategy object for Buchberger test (static)", "building s-polynomial", "reduction of s-polynomial", "PRODUCT CRITERION", "CHAIN CRITERION");
  output.fieldnames[3] = "runtimes_per_transition";
  output.data[3] = list(list(0,-2^31),list(0,0,0),          list(0,0,0),list(0,0,0),list(0,0,0),list(0,0,0),list(0,0,0),list(0,0,0),list(0,0,0),list(0,0,0),list(0,0,0),list(0,0,0),list(0,0,0),list(0,0,0));
  output.fieldnames[4]="spoly_that_did_not_reduce_to_zero";
  output.data[4] = list(-1,-1);

  return(output);
}

proc abort_BB_test(list BB_test_fail, token output)
{
  output.data[1] = 0;

  output.data[4] = BB_test_fail;

  return(output);
}

// for debugging as error messages wont be pushed to gspc-monitor:
static proc debug(string DIR, def object, def filename, list #)
{
  if(size(#)==0) {#[1]="";}
  if(#[1]!="") {link l=   ":a "+DIR+string(filename); write(l, typeof(object)+": "+sprintf(#[1], object)); close(l);}
  else         {link l="ssi:w "+DIR+string(filename); write(l, object);                                    close(l);}
}
